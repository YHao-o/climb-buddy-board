{% extends "base.html" %}

{% block content %}
<section class="hero">
  <h1 class="hero__title">ğŸ§— çº¦æ”€</h1>
  <p class="hero__subtitle">æ‰¾æ­å­ä¸€èµ·çˆ¬ï¼Œäº’ç›¸æ‰“æ°”è¿›æ­¥æ›´å¿«ï¼</p>
</section>

    <div class="info-badges">
      <span class="info-badge">
        <span class="info-badge__icon">ğŸ“…</span>
        å¯é¢„çº¦æœªæ¥ 5 å¤©
      </span>
      <span class="info-badge">
        <span class="info-badge__icon">âœï¸</span>
        ä»»ä½•äººå¯å‘èµ·/åˆ é™¤
      </span>
      <span class="info-badge">
        <span class="info-badge__icon">â°</span>
        è¿‡æœŸè‡ªåŠ¨æ ‡çº¢
      </span>
    </div>

    {% if err %}
    <div class="alert alert--error">
      <span class="alert__icon">âš ï¸</span>
      <span class="alert__text">{{ err }}</span>
    </div>
    {% endif %}

    {% if msg %}
    <div class="alert alert--success">
      <span class="alert__icon">âœ…</span>
      <span class="alert__text">{{ msg }}</span>
    </div>
    {% endif %}

    <section class="form-card">
      <h2 class="form-card__title">å‘èµ·ä¸€ä¸ªçº¦æ”€</h2>
      <form method="post" action="/events/new">
        <div class="form-grid">
          <label class="field">
            <span class="field__label">æ—¶é—´</span>
            <input class="input" type="datetime-local" name="when" required />
          </label>
          <label class="field">
            <span class="field__label">åœ°ç‚¹</span>
            <input class="input" name="location" placeholder="é¦™è•‰ / å²©æ—¶ / æˆ·å¤–ç‚¹â€¦" required />
          </label>
          <label class="field">
            <span class="field__label">ä½ çš„æ˜µç§°</span>
            <input class="input" name="nickname" placeholder="ç¾¤æ˜µç§°" required />
          </label>
          <button class="btn btn--primary" type="submit">ğŸ¯ å‘å¸ƒ</button>
          <a class="btn btn--secondary" href="/">æ¸…ç©º</a>
        </div>
      </form>
    </section>

    <section class="summary">
      <div class="summary__stats">
        <div class="stat">
          <span class="stat__value">{{ upcoming|length }}</span>
          <span class="stat__label">è¿›è¡Œä¸­</span>
        </div>
        <div class="stat">
          <span class="stat__value">{{ expired|length }}</span>
          <span class="stat__label">å·²è¿‡æœŸ</span>
        </div>
      </div>
    </section>

    {% if upcoming|length > 0 %}
    <section class="events-grid">
      {% for e in upcoming %}
      <article class="event-card">
        {% set share_url = 'https://panyanfor.fun/events/' ~ e.id %}
        {% set participants_text = (e.participants|length > 0) and ('- ' ~ e.participants|join('\\n- ')) or 'æš‚æ— ' %}
        {% set share_text = 'ğŸ§— çº¦æ”€é‚€è¯·\\næ—¶é—´ï¼š' ~ e.start_text_weekday ~ '\\nåœ°ç‚¹ï¼š' ~ e.location ~ '\\nå‘èµ·äººï¼š' ~ (e.host_nickname or
        e.nickname) ~ '\\nå·²æŠ¥åï¼š' ~ (e.participants|length) ~ ' äºº\\næŠ¥åæ˜µç§°ï¼š\\n' ~ participants_text ~ '\\né“¾æ¥ï¼š' ~ share_url %}
        <div class="event-card__header">
          <div class="event-card__time">{{ e.start_text_weekday }}</div>
          <span class="event-card__status event-card__status--active">è¿›è¡Œä¸­</span>
        </div>

        <div class="event-card__body">
          <div class="event-card__location">{{ e.location }}</div>
          <div class="event-card__host">
            å‘èµ·äººï¼š<strong>{{ e.host_nickname or e.nickname }}</strong>
          </div>
        </div>

        <div class="participants">
          <div class="participants__title">å·²æŠ¥å ({{ e.participants|length }}äºº)</div>

          {% if e.participants|length > 0 %}
          <div class="participants__list">
            {% for p in e.participants %}
            <span class="participant">
              {{ p }}
              <form method="post" action="/events/{{ e.id }}/leave" class="inline"
                data-confirm="ç¡®è®¤å–æ¶ˆæŠ¥åï¼Ÿ&#10;æ´»åŠ¨ï¼š{{ e.start_text }}ï½œ{{ e.location }}&#10;æ˜µç§°ï¼š{{ p }}">
                <input type="hidden" name="nickname" value="{{ p }}" />
                <button type="submit" class="participant__remove" title="å–æ¶ˆæŠ¥å">Ã—</button>
              </form>
            </span>
            {% endfor %}
          </div>
          {% else %}
          <p class="participants__empty">æš‚æ— äººæŠ¥åï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªï¼</p>
          {% endif %}

          <form method="post" action="/events/{{ e.id }}/join" class="participants__join">
            <input class="input" name="nickname" placeholder="æˆ‘ä¹Ÿè¦å»ï¼ˆå¡«æ˜µç§°ï¼‰" required />
            <button class="btn btn--primary btn--small" type="submit">ğŸ™‹ æŠ¥å</button>
          </form>
        </div>

        <div class="event-card__actions">
          <button class="btn btn--ghost btn--small" type="button" data-invite-text="{{ share_text|e }}">ğŸ“£ é‚€è¯·</button>
          <form method="post" action="/events/{{ e.id }}/delete" class="inline"
            data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ&#10;{{ e.start_text }}ï½œ{{ e.location }}ï½œ{{ e.host_nickname or e.nickname }}">
            <button class="btn btn--ghost btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
          </form>
        </div>
      </article>
      {% endfor %}
    </section>
    {% endif %}

    {% if expired|length > 0 %}
    <div class="section-divider">
      <span class="section-divider__line"></span>
      <span class="section-divider__text">å·²è¿‡æœŸ</span>
      <span class="section-divider__line"></span>
    </div>

    <section class="events-grid">
      {% for e in expired %}
      <article class="event-card event-card--expired">
        {% set share_url = 'https://panyanfor.fun/events/' ~ e.id %}
        {% set participants_text = (e.participants|length > 0) and ('- ' ~ e.participants|join('\\n- ')) or 'æš‚æ— ' %}
        {% set share_text = 'ğŸ§— çº¦æ”€é‚€è¯·\\næ—¶é—´ï¼š' ~ e.start_text_weekday ~ '\\nåœ°ç‚¹ï¼š' ~ e.location ~ '\\nå‘èµ·äººï¼š' ~ (e.host_nickname or
        e.nickname) ~ '\\nå·²æŠ¥åï¼š' ~ (e.participants|length) ~ ' äºº\\næŠ¥åæ˜µç§°ï¼š\\n' ~ participants_text ~ '\\né“¾æ¥ï¼š' ~ share_url %}
        <div class="event-card__header">
          <div class="event-card__time">{{ e.start_text_weekday }}</div>
          <span class="event-card__status event-card__status--expired">å·²è¿‡æœŸ</span>
        </div>

        <div class="event-card__body">
          <div class="event-card__location">{{ e.location }}</div>
          <div class="event-card__host">
            å‘èµ·äººï¼š<strong>{{ e.host_nickname or e.nickname }}</strong>
          </div>
        </div>

        <div class="participants">
          <div class="participants__title">å‚ä¸è€… ({{ e.participants|length }}äºº)</div>

          {% if e.participants|length > 0 %}
          <div class="participants__list">
            {% for p in e.participants %}
            <span class="participant">{{ p }}</span>
            {% endfor %}
          </div>
          {% else %}
          <p class="participants__empty">â€”</p>
          {% endif %}
        </div>

        <div class="event-card__actions">
          <form method="post" action="/events/{{ e.id }}/delete" class="inline"
            data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ&#10;{{ e.start_text }}ï½œ{{ e.location }}ï½œ{{ e.host_nickname or e.nickname }}">
            <button class="btn btn--ghost btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
          </form>
        </div>
      </article>
      {% endfor %}
    </section>
    {% endif %}

{% if upcoming|length == 0 and expired|length == 0 %}
<section class="empty-state">
  <div class="empty-state__icon">ğŸ”ï¸</div>
  <h3 class="empty-state__title">è¿˜æ²¡æœ‰çº¦æ”€æ´»åŠ¨</h3>
  <p class="empty-state__text">æˆä¸ºç¬¬ä¸€ä¸ªå‘èµ·çº¦æ”€çš„äººå§ï¼</p>
</section>
{% endif %}

{% set board_base_url = base_url if base_url else 'https://panyanfor.fun' %}
{% set ns = namespace(text='æœ¬æ‘å‘¨å†') %}
{% for day in week_board %}
  {% set ns.text = ns.text ~ '\\n\\n' ~ day.title %}
  {% if day["items"]|length > 0 %}
    {% for item in day["items"] %}
      {% set ns.text = ns.text ~ '\\n- æ—¶é—´ï¼š' ~ item.full_time ~ ' åœ°ç‚¹ï¼š' ~ item.location %}
      {% if item.is_active %}
        {% set detail_url = board_base_url ~ item.detail_url %}
        {% set ns.text = ns.text ~ ' æŠ¥åï¼š' ~ detail_url %}
      {% endif %}
    {% endfor %}
  {% else %}
    {% set ns.text = ns.text ~ '\\n- æš‚æ— å®‰æ’' %}
  {% endif %}
{% endfor %}

<aside class="week-board-float" aria-label="æœ¬æ‘å‘¨å†">
  <section class="week-board">
    <div class="week-board__header">
      <div>
        <h2 class="week-board__title">æœ¬æ‘å‘¨å†</h2>
        <p class="week-board__subtitle">ä»…å±•ç¤ºæœ¬å‘¨</p>
      </div>
      <button class="btn btn--ghost btn--small" type="button" data-copy-text="{{ ns.text|e }}">ä¸€é”®å¤åˆ¶</button>
    </div>
    <div class="week-board__body">
      {% for day in week_board %}
      <div class="week-day">
        <div class="week-day__title">{{ day.title }}</div>
        {% if day["items"]|length > 0 %}
        <div class="week-day__items">
          {% for item in day["items"] %}
          <div class="week-day__item">
            <span class="week-day__period">{{ item.period }}ï¼š</span>
            <span class="week-day__time">{{ item.full_time }}</span>
            <span class="week-day__location">{{ item.location }}</span>
            {% if item.is_active %}
            {% set detail_url = board_base_url ~ item.detail_url %}
            <a class="link week-day__link" href="{{ detail_url }}">æŠ¥å</a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="week-day__empty">æš‚æ— å®‰æ’</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </section>
</aside>

{% endblock %}