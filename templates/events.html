{% extends "base.html" %}

{% block content %}
<section class="hero">
  <h1 class="hero__title"><span class="hero__emoji" aria-hidden="true">ğŸ§—</span><span class="hero__title-text">çº¦æ”€</span>
  </h1>
  <p class="hero__subtitle">æ‰¾æ­å­ä¸€èµ·çˆ¬ï¼Œäº’ç›¸æ‰“æ°”è¿›æ­¥æ›´å¿«ï¼</p>
</section>

<div class="info-badges">
  <span class="info-badge">
    <span class="info-badge__icon">ğŸ“…</span>
    å¯é¢„çº¦æœªæ¥ 5 å¤©
  </span>
  <span class="info-badge">
    <span class="info-badge__icon">âœï¸</span>
    ä»»ä½•äººå¯å‘èµ·/åˆ é™¤
  </span>
  <span class="info-badge">
    <span class="info-badge__icon">â°</span>
    è¿‡æœŸè‡ªåŠ¨æ ‡çº¢
  </span>
  <span class="info-badge" id="events-refresh-badge" title="æ¯ 2 ç§’è‡ªåŠ¨æ‹‰å– /api/events">
    <span class="info-badge__icon">ğŸ”„</span>
    2s è‡ªåŠ¨åˆ·æ–°
  </span>
</div>

{% if err %}
<div class="alert alert--error">
  <span class="alert__icon">âš ï¸</span>
  <span class="alert__text">{{ err }}</span>
</div>
{% endif %}

{% if msg %}
<div class="alert alert--success">
  <span class="alert__icon">âœ…</span>
  <span class="alert__text">{{ msg }}</span>
</div>
{% endif %}

{% set board_base_url = base_url if base_url else 'http://120.79.176.134:8000' %}
{% set ns = namespace(text='æœ¬æ‘å‘¨å†') %}
{% for day in week_board %}
{% set ns.text = ns.text ~ '\\n\\n' ~ day.title %}
{% if day["items"]|length > 0 %}
{% for item in day["items"] %}
{% set ns.text = ns.text ~ '\\n- æ—¶é—´ï¼š' ~ item.time_text ~ ' åœ°ç‚¹ï¼š' ~ item.location %}
{% if item.is_active %}
{% set detail_url = board_base_url ~ item.detail_url %}
{% set ns.text = ns.text ~ ' æŠ¥åï¼š' ~ detail_url %}
{% endif %}
{% endfor %}
{% else %}
{% set ns.text = ns.text ~ '\\n- æš‚æ— å®‰æ’' %}
{% endif %}
{% endfor %}

<details class="collapse collapse--weekboard">
  <summary>
    <span>ğŸ“… æœ¬æ‘å‘¨å†</span>
    <span class="collapse__hint">ç‚¹å‡»å±•å¼€</span>
  </summary>
  <div class="collapse__body">
    <section class="week-board-block" aria-label="æœ¬æ‘å‘¨å†">
      <section class="week-board">
        <div class="week-board__header">
          <div>
            <h2 class="week-board__title">æœ¬æ‘å‘¨å†</h2>
            <p class="week-board__subtitle">ä»…å±•ç¤ºæœ¬å‘¨ï¼ˆå‘¨ä¸€ï½å‘¨æ—¥ï¼‰</p>
          </div>
          <button class="btn btn--ghost btn--small" type="button" data-copy-text="{{ ns.text|e }}">ä¸€é”®å¤åˆ¶</button>
        </div>
        <div class="week-board__body">
          {% for day in week_board %}
          <div class="week-day {{ 'week-day--today' if day.is_today else '' }}">
            <div class="week-day__title">{{ day.title }}</div>
            {% if day["items"]|length > 0 %}
            <div class="week-day__items">
              {% for item in day["items"] %}
              <div class="week-day__item">
                <span class="week-day__time">{{ item.time_text }}</span>
                <span class="week-day__location">{{ item.location }}</span>
                {% if item.is_active %}
                {% set detail_url = board_base_url ~ item.detail_url %}
                <a class="link week-day__link" href="{{ detail_url }}">æŠ¥å</a>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="week-day__empty">æš‚æ— å®‰æ’</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </section>
    </section>
  </div>
</details>

<details class="collapse collapse--eventform" id="new-event">
  <summary>
    <span>â• å‘èµ·çº¦æ”€</span>
    <span class="collapse__hint">ç‚¹å‡»å±•å¼€</span>
  </summary>
  <div class="collapse__body">
    <form method="post" action="/events/new">
      <div class="form-grid">
        <label class="field">
          <span class="field__label">æ—¶é—´</span>
          <input id="climbing-time" class="input" type="datetime-local" name="when" required/>
        </label>
        <label class="field">
          <span class="field__label">åœ°ç‚¹</span>
          <input class="input" name="location" placeholder="é¦™è•‰ / å²©æ—¶ / æˆ·å¤–ç‚¹â€¦" required list="climbing-gym" />
          <datalist id="climbing-gym">

            <!-- é¦™è•‰æ”€å²© -->
            <option value="é¦™è•‰(é‡‘è¶åº—)"></option>
            <option value="é¦™è•‰(åæµ·æ±‡åº—)"></option>
            <option value="é¦™è•‰(å®å®‰ä¸­å¿ƒåº—)"></option>
            <option value="é¦™è•‰(é¢†å±•ä¸­å¿ƒåŸåº—)"></option>
            <option value="é¦™è•‰(iNåŸå¸‚å¹¿åœºåº—)"></option>
            <option value="é¦™è•‰(BANANA+/å˜‰ä¹é“åº—)"></option>

            <!-- Upperæ”€å²© -->
            <option value="Upper(æ·±åº·åº—)"></option>
            <option value="Upper(å—å…‰åº—)"></option>
            <option value="Upper(é¾™ååº—)"></option>

            <!-- é—ªç”µæ”€å²© -->
            <option value="é—ªç”µ(æ·±åœ³æ¹¾åº—)"></option>
            <option value="é—ªç”µ(å²—å¤åº—)"></option>

            <!-- CUBE -->
            <option value="CUBEæœ‰çŸ³(å®ä½“åº—)"></option>
            <option value="CUBEæœ‰çŸ³(æ¹–è´åº—)"></option>

            <!-- å‘¢åº¦æœ‰å®¶ -->
            <option value="å‘¢åº¦æœ‰å®¶(å²—å¤åŒ—åº—)"></option>
            <option value="å‘¢åº¦æœ‰å®¶(å“æ‚¦æ±‡åº—)"></option>

            <!-- é˜¿å» -->
            <option value="é˜¿å»(æ€¡æ™¯åŠ¨æ¼«å¤§å¦åº—)"></option>

            <!-- æ™®å²š -->
            <option value="æ™®å²š(å—æ²¹æ°¸æ–°æ±‡åº—)"></option>

            <!-- è“å¤© -->
            <option value="å—å±±è“å¤©(åç€šåˆ›æ–°å›­åº—)"></option>
            <option value="ç¦ç”°è“å¤©(ä½“è‚²å…¬å›­åº—)"></option>
            <option value="ç¦ç”°è“å¤©(æ·±ä¸šä¸ŠåŸåº—)"></option>
            <option value="ç½—æ¹–è“å¤©(ç›Šç”°å‡æ—¥å¹¿åœºåº—)"></option>
            <option value="ç½—æ¹–è“å¤©(ä¹åŠ¨åŠ›ç¿ å›­ååºœåº—)"></option>
            <option value="ç½—æ¹–è“å¤©(æ”¿åŠ¡ä¸­å¿ƒåº—)"></option>

            <option value="æˆ·å¤–"></option>
          </datalist>
        </label>
        <label class="field">
          <span class="field__label">ä½ çš„æ˜µç§°</span>
          <input class="input" name="nickname" placeholder="ç¾¤æ˜µç§°" required />
        </label>
        <button class="btn btn--primary" type="submit">ğŸ¯ å‘å¸ƒ</button>
        <a class="btn btn--secondary" href="/">æ¸…ç©º</a>
      </div>
    </form>
  </div>
</details>

<section class="summary">
  <div class="summary__stats">
    <div class="stat">
      <span class="stat__value" id="upcoming-count">{{ upcoming|length }}</span>
      <span class="stat__label">è¿›è¡Œä¸­</span>
    </div>
    <div class="stat">
      <span class="stat__value" id="expired-count">{{ expired|length }}</span>
      <span class="stat__label">å·²è¿‡æœŸ</span>
    </div>
  </div>
</section>

<div id="upcoming-block">
  <section class="events-grid" id="upcoming-grid">
    {% for e in upcoming %}
    <article class="event-card" data-event-id="{{ e.id }}">
      {% set share_url = base_url and (base_url.rstrip('/') ~ '/events/' ~ e.id) or ('/events/' ~ e.id) %}
      {% set participants_text = (e.participants|length > 0) and ('- ' ~ e.participants|join('\\n- ')) or 'æš‚æ— ' %}
      {% set share_text = 'ğŸ§— çº¦æ”€é‚€è¯·\\næ—¶é—´ï¼š' ~ e.start_text_weekday ~ '\\nåœ°ç‚¹ï¼š' ~ e.location ~ '\\nå‘èµ·äººï¼š' ~ (e.host_nickname
      or
      e.nickname) ~ '\\nå·²æŠ¥åï¼š' ~ (e.participants|length) ~ ' äºº\\næŠ¥åæ˜µç§°ï¼š\\n' ~ participants_text ~ '\\né“¾æ¥ï¼š' ~ share_url %}
      <div class="event-card__header">
        <div class="event-card__time">{{ e.start_text_weekday }}</div>
        <span class="event-card__status event-card__status--active">è¿›è¡Œä¸­</span>
      </div>

      <div class="event-card__body">
        <div class="event-card__location">{{ e.location }}</div>
        <div class="event-card__host">
          å‘èµ·äººï¼š<strong>{{ e.host_nickname or e.nickname }}</strong>
        </div>
      </div>

      <div class="participants">
        <div class="participants__title">å·²æŠ¥å ({{ e.participants|length }}äºº)</div>

        {% if e.participants|length > 0 %}
        <div class="participants__list">
          {% for p in e.participants %}
          <span class="participant">
            {{ p }}
            <form method="post" action="/events/{{ e.id }}/leave" class="inline"
              data-confirm="ç¡®è®¤å–æ¶ˆæŠ¥åï¼Ÿ&#10;æ´»åŠ¨ï¼š{{ e.start_text }}ï½œ{{ e.location }}&#10;æ˜µç§°ï¼š{{ p }}">
              <input type="hidden" name="nickname" value="{{ p }}" />
              <button type="submit" class="participant__remove" title="å–æ¶ˆæŠ¥å">Ã—</button>
            </form>
          </span>
          {% endfor %}
        </div>
        {% else %}
        <p class="participants__empty">æš‚æ— äººæŠ¥åï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªï¼</p>
        {% endif %}

        <form method="post" action="/events/{{ e.id }}/join" class="participants__join">
          <input class="input" name="nickname" placeholder="æˆ‘ä¹Ÿè¦å»ï¼ˆå¡«æ˜µç§°ï¼‰" required />
          <button class="btn btn--primary btn--small" type="submit">ğŸ™‹ æŠ¥å</button>
        </form>
      </div>

      <div class="event-card__actions">
        <button class="btn btn--ghost btn--small" type="button" data-invite-text="{{ share_text|e }}">ğŸ“£ é‚€è¯·</button>
        <form method="post" action="/events/{{ e.id }}/delete" class="inline"
          data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ&#10;{{ e.start_text }}ï½œ{{ e.location }}ï½œ{{ e.host_nickname or e.nickname }}">
          <button class="btn btn--ghost btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
      </div>
    </article>
    {% endfor %}
  </section>
</div>

<div id="expired-block">
  <div class="section-divider" id="expired-divider" {% if expired|length==0 %}style="display:none" {% endif %}>
    <span class="section-divider__line"></span>
    <span class="section-divider__text">å·²è¿‡æœŸ</span>
    <span class="section-divider__line"></span>
  </div>

  <section class="events-grid" id="expired-grid">
    {% for e in expired %}
    <article class="event-card event-card--expired" data-event-id="{{ e.id }}">
      {% set share_url = base_url and (base_url.rstrip('/') ~ '/events/' ~ e.id) or ('/events/' ~ e.id) %}
      {% set participants_text = (e.participants|length > 0) and ('- ' ~ e.participants|join('\\n- ')) or 'æš‚æ— ' %}
      {% set share_text = 'ğŸ§— çº¦æ”€é‚€è¯·\\næ—¶é—´ï¼š' ~ e.start_text_weekday ~ '\\nåœ°ç‚¹ï¼š' ~ e.location ~ '\\nå‘èµ·äººï¼š' ~ (e.host_nickname
      or
      e.nickname) ~ '\\nå·²æŠ¥åï¼š' ~ (e.participants|length) ~ ' äºº\\næŠ¥åæ˜µç§°ï¼š\\n' ~ participants_text ~ '\\né“¾æ¥ï¼š' ~ share_url %}
      <div class="event-card__header">
        <div class="event-card__time">{{ e.start_text_weekday }}</div>
        <span class="event-card__status event-card__status--expired">å·²è¿‡æœŸ</span>
      </div>

      <div class="event-card__body">
        <div class="event-card__location">{{ e.location }}</div>
        <div class="event-card__host">
          å‘èµ·äººï¼š<strong>{{ e.host_nickname or e.nickname }}</strong>
        </div>
      </div>

      <div class="participants">
        <div class="participants__title">å‚ä¸è€… ({{ e.participants|length }}äºº)</div>

        {% if e.participants|length > 0 %}
        <div class="participants__list">
          {% for p in e.participants %}
          <span class="participant">{{ p }}</span>
          {% endfor %}
        </div>
        {% else %}
        <p class="participants__empty">â€”</p>
        {% endif %}
      </div>

      <div class="event-card__actions">
        <form method="post" action="/events/{{ e.id }}/delete" class="inline"
          data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ&#10;{{ e.start_text }}ï½œ{{ e.location }}ï½œ{{ e.host_nickname or e.nickname }}">
          <button class="btn btn--ghost btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
      </div>
    </article>
    {% endfor %}
  </section>
</div>

<div id="empty-block">
  <section class="empty-state" id="empty-state" {% if upcoming|length> 0 or expired|length > 0 %}style="display:none"{%
    endif %}>
    <div class="empty-state__icon">ğŸ”ï¸</div>
    <h3 class="empty-state__title">è¿˜æ²¡æœ‰çº¦æ”€æ´»åŠ¨</h3>
    <p class="empty-state__text">æˆä¸ºç¬¬ä¸€ä¸ªå‘èµ·çº¦æ”€çš„äººå§ï¼</p>
  </section>
</div>

<script>
  // çº¦æ”€åˆ—è¡¨ï¼šå›ºå®š 2s åˆ·æ–°ï¼ˆå¤šäººè®¿é—®ä¸é˜»å¡ï¼‰
  document.addEventListener('DOMContentLoaded', () => {
    const REFRESH_MS = 2000
    const upcomingCountEl = document.getElementById('upcoming-count')
    const expiredCountEl = document.getElementById('expired-count')
    const upcomingGrid = document.getElementById('upcoming-grid')
    const expiredGrid = document.getElementById('expired-grid')
    const expiredDivider = document.getElementById('expired-divider')
    const emptyState = document.getElementById('empty-state')
    const modal = document.getElementById('confirm-modal')

    if (!upcomingGrid || !expiredGrid || !expiredDivider || !emptyState) return

    const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]))
    const escAttrWithNewlines = (s) => esc(s).replace(/\n/g, '&#10;')

    const buildInviteText = (e) => {
      const origin = window.location.origin
      const shareUrl = `${origin}/events/${e.id}`
      const host = e.host_nickname || e.nickname || ''
      const participants = Array.isArray(e.participants) ? e.participants : []
      const participantsText = participants.length > 0 ? ('- ' + participants.join('\\n- ')) : 'æš‚æ— '
      return `ğŸ§— çº¦æ”€é‚€è¯·\\næ—¶é—´ï¼š${e.start_text_weekday || e.start_text || ''}` +
        `\\nåœ°ç‚¹ï¼š${e.location || ''}` +
        `\\nå‘èµ·äººï¼š${host}` +
        `\\nå·²æŠ¥åï¼š${participants.length} äºº` +
        `\\næŠ¥åæ˜µç§°ï¼š\\n${participantsText}` +
        `\\né“¾æ¥ï¼š${shareUrl}`
    }

    const eventSig = (e) => {
      const host = e.host_nickname || e.nickname || ''
      const participants = Array.isArray(e.participants) ? e.participants : []
      // ignore now_ts to prevent unnecessary re-render
      return [
        e.id,
        e.start_ts,
        e.start_text,
        e.start_text_weekday,
        e.location,
        host,
        participants.join('|'),
      ].join('~')
    }

    const listSig = (upcoming, expired) => {
      const up = (upcoming || []).map(eventSig).join('||')
      const ex = (expired || []).map(eventSig).join('||')
      return `${up}##${ex}`
    }

    const setTextIfChanged = (el, text) => {
      const t = String(text ?? '')
      if (el && el.textContent !== t) el.textContent = t
    }

    const ensureBlocksVisibility = (upcomingLen, expiredLen) => {
      expiredDivider.style.display = expiredLen > 0 ? '' : 'none'
      emptyState.style.display = (upcomingLen === 0 && expiredLen === 0) ? '' : 'none'
    }

    const setUpcomingParticipants = (card, e) => {
      const participants = Array.isArray(e.participants) ? e.participants : []
      const partSig = participants.join('\u0001')
      if (card.dataset.partSig === partSig) return
      card.dataset.partSig = partSig

      const participantsBox = card.querySelector('.participants')
      if (!participantsBox) return

      const titleEl = participantsBox.querySelector('.participants__title')
      if (titleEl) titleEl.textContent = `å·²æŠ¥å (${participants.length}äºº)`

      const oldList = participantsBox.querySelector('.participants__list')
      const oldEmpty = participantsBox.querySelector('.participants__empty')
      if (oldList) oldList.remove()
      if (oldEmpty) oldEmpty.remove()

      if (participants.length > 0) {
        const list = document.createElement('div')
        list.className = 'participants__list'
        participants.forEach(p => {
          const wrap = document.createElement('span')
          wrap.className = 'participant'
          wrap.appendChild(document.createTextNode(String(p)))

          const form = document.createElement('form')
          form.method = 'post'
          form.action = `/events/${e.id}/leave`
          form.className = 'inline'
          form.dataset.confirm = `ç¡®è®¤å–æ¶ˆæŠ¥åï¼Ÿ\næ´»åŠ¨ï¼š${e.start_text}ï½œ${e.location}\næ˜µç§°ï¼š${p}`

          const hidden = document.createElement('input')
          hidden.type = 'hidden'
          hidden.name = 'nickname'
          hidden.value = String(p)
          form.appendChild(hidden)

          const btn = document.createElement('button')
          btn.type = 'submit'
          btn.className = 'participant__remove'
          btn.title = 'å–æ¶ˆæŠ¥å'
          btn.textContent = 'Ã—'
          form.appendChild(btn)

          wrap.appendChild(form)
          list.appendChild(wrap)
        })
        const joinForm = participantsBox.querySelector('form.participants__join')
        participantsBox.insertBefore(list, joinForm || null)
      } else {
        const empty = document.createElement('p')
        empty.className = 'participants__empty'
        empty.textContent = 'æš‚æ— äººæŠ¥åï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªï¼'
        const joinForm = participantsBox.querySelector('form.participants__join')
        participantsBox.insertBefore(empty, joinForm || null)
      }
    }

    const setExpiredParticipants = (card, e) => {
      const participants = Array.isArray(e.participants) ? e.participants : []
      const partSig = participants.join('\u0001')
      if (card.dataset.partSig === partSig) return
      card.dataset.partSig = partSig

      const participantsBox = card.querySelector('.participants')
      if (!participantsBox) return
      const titleEl = participantsBox.querySelector('.participants__title')
      if (titleEl) titleEl.textContent = `å‚ä¸è€… (${participants.length}äºº)`

      const oldList = participantsBox.querySelector('.participants__list')
      const oldEmpty = participantsBox.querySelector('.participants__empty')
      if (oldList) oldList.remove()
      if (oldEmpty) oldEmpty.remove()

      if (participants.length > 0) {
        const list = document.createElement('div')
        list.className = 'participants__list'
        participants.forEach(p => {
          const sp = document.createElement('span')
          sp.className = 'participant'
          sp.textContent = String(p)
          list.appendChild(sp)
        })
        participantsBox.appendChild(list)
      } else {
        const empty = document.createElement('p')
        empty.className = 'participants__empty'
        empty.textContent = 'â€”'
        participantsBox.appendChild(empty)
      }
    }

    const updateUpcomingCardMeta = (card, e) => {
      const host = e.host_nickname || e.nickname || ''
      const metaSig = [e.start_ts, e.start_text, e.start_text_weekday, e.location, host].join('|')
      if (card.dataset.metaSig !== metaSig) {
        card.dataset.metaSig = metaSig
        const timeEl = card.querySelector('.event-card__time')
        const locEl = card.querySelector('.event-card__location')
        const hostEl = card.querySelector('.event-card__host strong')
        setTextIfChanged(timeEl, e.start_text_weekday || e.start_text || '')
        setTextIfChanged(locEl, e.location || '')
        setTextIfChanged(hostEl, host)

        const joinForm = card.querySelector('form.participants__join')
        if (joinForm) joinForm.action = `/events/${e.id}/join`
        const delForm = card.querySelector('form[action^="/events/"][action$="/delete"]')
        if (delForm) {
          delForm.action = `/events/${e.id}/delete`
          delForm.dataset.confirm = `ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ\n${e.start_text}ï½œ${e.location}ï½œ${host}`
        }
      }

      const inviteBtn = card.querySelector('[data-invite-text]')
      if (inviteBtn) inviteBtn.dataset.inviteText = buildInviteText(e)
    }

    const updateExpiredCardMeta = (card, e) => {
      const host = e.host_nickname || e.nickname || ''
      const metaSig = [e.start_ts, e.start_text, e.start_text_weekday, e.location, host].join('|')
      if (card.dataset.metaSig !== metaSig) {
        card.dataset.metaSig = metaSig
        const timeEl = card.querySelector('.event-card__time')
        const locEl = card.querySelector('.event-card__location')
        const hostEl = card.querySelector('.event-card__host strong')
        setTextIfChanged(timeEl, e.start_text_weekday || e.start_text || '')
        setTextIfChanged(locEl, e.location || '')
        setTextIfChanged(hostEl, host)

        const delForm = card.querySelector('form[action^="/events/"][action$="/delete"]')
        if (delForm) {
          delForm.action = `/events/${e.id}/delete`
          delForm.dataset.confirm = `ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ\n${e.start_text}ï½œ${e.location}ï½œ${host}`
        }
      }
    }

    const createUpcomingCard = (e) => {
      const host = e.host_nickname || e.nickname || ''
      const participants = Array.isArray(e.participants) ? e.participants : []
      const participantsHtml = participants.length > 0
        ? `<div class="participants__list">` + participants.map(p => {
          const confirmText = `ç¡®è®¤å–æ¶ˆæŠ¥åï¼Ÿ\næ´»åŠ¨ï¼š${e.start_text}ï½œ${e.location}\næ˜µç§°ï¼š${p}`
          return `<span class="participant">${esc(p)}` +
            `<form method="post" action="/events/${esc(e.id)}/leave" class="inline" data-confirm="${escAttrWithNewlines(confirmText)}">` +
            `<input type="hidden" name="nickname" value="${esc(p)}" />` +
            `<button type="submit" class="participant__remove" title="å–æ¶ˆæŠ¥å">Ã—</button>` +
            `</form></span>`
        }).join('') + `</div>`
        : `<p class="participants__empty">æš‚æ— äººæŠ¥åï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªï¼</p>`

      const inviteText = buildInviteText(e)
      const deleteConfirm = `ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ\n${e.start_text}ï½œ${e.location}ï½œ${host}`
      const html = `<article class="event-card" data-event-id="${esc(e.id)}">` +
        `<div class="event-card__header">` +
        `<div class="event-card__time">${esc(e.start_text_weekday || e.start_text || '')}</div>` +
        `<span class="event-card__status event-card__status--active">è¿›è¡Œä¸­</span>` +
        `</div>` +
        `<div class="event-card__body">` +
        `<div class="event-card__location">${esc(e.location || '')}</div>` +
        `<div class="event-card__host">å‘èµ·äººï¼š<strong>${esc(host)}</strong></div>` +
        `</div>` +
        `<div class="participants">` +
        `<div class="participants__title">å·²æŠ¥å (${participants.length}äºº)</div>` +
        `${participantsHtml}` +
        `<form method="post" action="/events/${esc(e.id)}/join" class="participants__join">` +
        `<input class="input" name="nickname" placeholder="æˆ‘ä¹Ÿè¦å»ï¼ˆå¡«æ˜µç§°ï¼‰" required />` +
        `<button class="btn btn--primary btn--small" type="submit">ğŸ™‹ æŠ¥å</button>` +
        `</form>` +
        `</div>` +
        `<div class="event-card__actions">` +
        `<button class="btn btn--ghost btn--small" type="button" data-invite-text="${esc(inviteText)}">ğŸ“£ é‚€è¯·</button>` +
        `<form method="post" action="/events/${esc(e.id)}/delete" class="inline" data-confirm="${escAttrWithNewlines(deleteConfirm)}">` +
        `<button class="btn btn--ghost btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>` +
        `</form>` +
        `</div>` +
        `</article>`
      const tpl = document.createElement('template')
      tpl.innerHTML = html
      return tpl.content.firstElementChild
    }

    const createExpiredCard = (e) => {
      const host = e.host_nickname || e.nickname || ''
      const participants = Array.isArray(e.participants) ? e.participants : []
      const participantsHtml = participants.length > 0
        ? `<div class="participants__list">` + participants.map(p => `<span class="participant">${esc(p)}</span>`).join('') + `</div>`
        : `<p class="participants__empty">â€”</p>`
      const deleteConfirm = `ç¡®è®¤åˆ é™¤è¿™æ¡æ´»åŠ¨ï¼Ÿ\n${e.start_text}ï½œ${e.location}ï½œ${host}`
      const html = `<article class="event-card event-card--expired" data-event-id="${esc(e.id)}">` +
        `<div class="event-card__header">` +
        `<div class="event-card__time">${esc(e.start_text_weekday || e.start_text || '')}</div>` +
        `<span class="event-card__status event-card__status--expired">å·²è¿‡æœŸ</span>` +
        `</div>` +
        `<div class="event-card__body">` +
        `<div class="event-card__location">${esc(e.location || '')}</div>` +
        `<div class="event-card__host">å‘èµ·äººï¼š<strong>${esc(host)}</strong></div>` +
        `</div>` +
        `<div class="participants">` +
        `<div class="participants__title">å‚ä¸è€… (${participants.length}äºº)</div>` +
        `${participantsHtml}` +
        `</div>` +
        `<div class="event-card__actions">` +
        `<form method="post" action="/events/${esc(e.id)}/delete" class="inline" data-confirm="${escAttrWithNewlines(deleteConfirm)}">` +
        `<button class="btn btn--ghost btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>` +
        `</form>` +
        `</div>` +
        `</article>`
      const tpl = document.createElement('template')
      tpl.innerHTML = html
      return tpl.content.firstElementChild
    }

    const patchGrid = (grid, events, type) => {
      const existing = new Map()
      grid.querySelectorAll('article[data-event-id]').forEach(node => {
        existing.set(String(node.dataset.eventId), node)
      })

      const seen = new Set()
      let prev = null
      events.forEach(e => {
        const id = String(e.id)
        let node = existing.get(id)
        if (!node) {
          node = type === 'upcoming' ? createUpcomingCard(e) : createExpiredCard(e)
        }

        // Update only changed parts
        if (type === 'upcoming') {
          updateUpcomingCardMeta(node, e)
          setUpcomingParticipants(node, e)
        } else {
          updateExpiredCardMeta(node, e)
          setExpiredParticipants(node, e)
        }

        // Ensure order matches server (events already sorted)
        if (prev === null) {
          if (grid.firstElementChild !== node) {
            grid.insertBefore(node, grid.firstElementChild)
          }
        } else {
          if (prev.nextElementSibling !== node) {
            grid.insertBefore(node, prev.nextElementSibling)
          }
        }
        prev = node
        seen.add(id)
      })

      existing.forEach((node, id) => {
        if (!seen.has(id)) node.remove()
      })
    }

    let inFlight = false
    let controller = null
    let lastPayload = ''

    const shouldSkipRefresh = () => {
      const active = document.activeElement
      if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT')) {
        return true
      }
      if (modal && modal.classList.contains('modal--open')) return true
      return false
    }

    const tick = async () => {
      if (inFlight || shouldSkipRefresh()) return
      inFlight = true
      if (controller) controller.abort()
      controller = new AbortController()
      try {
        const res = await fetch(`/api/events?t=${Date.now()}`, {
          method: 'GET',
          cache: 'no-store',
          signal: controller.signal,
          headers: { 'Accept': 'application/json' }
        })
        if (!res.ok) return
        const data = await res.json()
        const upcoming = Array.isArray(data.upcoming) ? data.upcoming : []
        const expired = Array.isArray(data.expired) ? data.expired : []

        const sig = listSig(upcoming, expired)
        if (sig === lastPayload) return
        lastPayload = sig

        setTextIfChanged(upcomingCountEl, upcoming.length)
        setTextIfChanged(expiredCountEl, expired.length)
        ensureBlocksVisibility(upcoming.length, expired.length)

        patchGrid(upcomingGrid, upcoming, 'upcoming')
        patchGrid(expiredGrid, expired, 'expired')
      } catch (e) {
        // ignore
      } finally {
        inFlight = false
      }
    }

    // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œç„¶åå›ºå®š 2s
    tick()
    window.setInterval(tick, REFRESH_MS)
  })
</script>

<script>
    // å‘èµ·çº¦æ”€ï¼šè®¾ç½®é»˜è®¤æ—¶é—´
    document.addEventListener('DOMContentLoaded', () => {
      const dateControl = document.querySelector('#climbing-time');
      const defaultDate = new Date();
      // åˆ¤æ–­æ—¶åŒº, è°ƒæ•´ä¸ºä¸œ8åŒºæ—¶é—´
      defaultDate.setMinutes(defaultDate.getMinutes() - defaultDate.getTimezoneOffset());
      // æŒ‰1åˆ»é’Ÿå–æ•´
      defaultDate.setMinutes(Math.ceil(defaultDate.getMinutes() / 15) * 15);
      dateControl.value = defaultDate.toISOString().slice(0,16);
    })

  // æ‘å†ï¼šå›ºå®š 2s åˆ·æ–°
  document.addEventListener('DOMContentLoaded', () => {
    const REFRESH_MS = 2000
    const boardBody = document.querySelector('.week-board__body')
    const copyBtn = document.querySelector('.week-board__header [data-copy-text]')
    if (!boardBody) return

    const origin = window.location.origin
    const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]))

    let lastSig = ''
    let inFlight = false

    // æ ¹æ® week_board JSON ç”Ÿæˆç­¾åï¼Œå˜åŒ–æ—¶æ‰é‡æ¸²
    const boardSig = (wb) => JSON.stringify(wb)

    // æ ¹æ® week_board JSON æ„é€ ä¸€é”®å¤åˆ¶çš„çº¯æ–‡æœ¬
    const buildCopyText = (wb) => {
      let text = 'æœ¬æ‘å‘¨å†'
      for (const day of wb) {
        text += '\n\n' + day.title
        if (day.items && day.items.length > 0) {
          for (const item of day.items) {
            text += '\n- æ—¶é—´ï¼š' + item.time_text + ' åœ°ç‚¹ï¼š' + item.location
            if (item.is_active) {
              text += ' æŠ¥åï¼š' + origin + item.detail_url
            }
          }
        } else {
          text += '\n- æš‚æ— å®‰æ’'
        }
      }
      return text
    }

    // é‡æ–°æ¸²æŸ“å‘¨å† HTML
    const renderBoard = (wb) => {
      let html = ''
      for (const day of wb) {
        const todayCls = day.is_today ? ' week-day--today' : ''
        html += `<div class="week-day${todayCls}">`
        html += `<div class="week-day__title">${esc(day.title)}</div>`
        if (day.items && day.items.length > 0) {
          html += '<div class="week-day__items">'
          for (const item of day.items) {
            html += '<div class="week-day__item">'
            html += `<span class="week-day__time">${esc(item.time_text)}</span>`
            html += `<span class="week-day__location">${esc(item.location)}</span>`
            if (item.is_active) {
              const detailUrl = origin + item.detail_url
              html += `<a class="link week-day__link" href="${esc(detailUrl)}">æŠ¥å</a>`
            }
            html += '</div>'
          }
          html += '</div>'
        } else {
          html += '<div class="week-day__empty">æš‚æ— å®‰æ’</div>'
        }
        html += '</div>'
      }
      boardBody.innerHTML = html
    }

    const tick = async () => {
      if (inFlight) return
      inFlight = true
      try {
        const resp = await fetch('/api/week-board')
        if (!resp.ok) return
        const data = await resp.json()
        const wb = data.week_board || []
        const sig = boardSig(wb)
        if (sig === lastSig) return
        lastSig = sig
        renderBoard(wb)
        if (copyBtn) {
          copyBtn.setAttribute('data-copy-text', buildCopyText(wb))
        }
      } catch (e) {
        // ignore
      } finally {
        inFlight = false
      }
    }

    tick()
    window.setInterval(tick, REFRESH_MS)
  })
</script>

{% endblock %}