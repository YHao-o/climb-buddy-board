{% extends "base.html" %}

{% block content %}
<section class="hero">
  <h1 class="hero__title"><span class="hero__emoji" aria-hidden="true">ğŸ“š</span><span
      class="hero__title-text">ç¾¤å›¾ä¹¦é¦†</span></h1>
  <p class="hero__subtitle">ç¾¤å‹å…±äº«èµ„æ–™åº“ï¼ŒçŸ¥è¯†å°±æ˜¯åŠ›é‡</p>
</section>

<div class="info-badges">
  <span class="info-badge">
    <span class="info-badge__icon">ğŸ“„</span>
    æ”¯æŒ {{ allowed_types }}
  </span>
  <span class="info-badge">
    <span class="info-badge__icon">â¬†ï¸</span>
    å•ä¸ªæ–‡ä»¶æœ€å¤§ {{ max_size_mb }}MB
  </span>
  <span class="info-badge">
    <span class="info-badge__icon">ğŸ“Š</span>
    ä»Šæ—¥å·²ä¼  {{ today_uploads }}/{{ max_daily_uploads }}
  </span>
</div>

<form class="library-search" method="get" action="/library" role="search" aria-label="æ–‡æ¡£æœç´¢">
  <div class="library-search__inner">
    <input class="input library-search__input" type="search" name="q" value="{{ q|e }}"
      placeholder="æœç´¢æ–‡ä»¶åå…³é”®è¯ï¼ˆæ”¯æŒç©ºæ ¼åˆ†è¯ï¼‰" />
    {% if q %}
    <a class="btn btn--secondary library-search__clear" href="/library">æ¸…ç©º</a>
    {% endif %}
    <button class="btn btn--primary library-search__btn" type="submit">ğŸ” æœç´¢</button>
  </div>
</form>

{% if err %}
<div class="alert alert--error">
  <span class="alert__icon">âš ï¸</span>
  <span class="alert__text">{{ err }}</span>
</div>
{% endif %}

{% if msg %}
<div class="alert alert--success">
  <span class="alert__icon">âœ…</span>
  <span class="alert__text">{{ msg }}</span>
</div>
{% endif %}

<!-- Upload Section -->
{% if can_upload %}
<details class="collapse collapse--upload">
  <summary>
    <span>â¬†ï¸ ä¸Šä¼ æ–‡æ¡£</span>
    <span class="collapse__hint">ç‚¹å‡»æ”¶èµ·</span>
  </summary>
  <div class="collapse__body">
    <form class="library-upload" method="post" action="/library/upload" enctype="multipart/form-data">
      <label class="library-upload__dropzone" id="dropzone">
        <input class="library-upload__input" type="file" name="file" accept=".pptx,.docx,.doc,.pdf" required />
        <div class="library-upload__icon">ğŸ“</div>
        <div class="library-upload__text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶</div>
        <div class="library-upload__hint">pptx / docx / doc / pdf Â· æœ€å¤§ {{ max_size_mb }}MB</div>
      </label>
      <button class="btn btn--primary library-upload__btn" type="submit">â¬†ï¸ ä¸Šä¼ æ–‡ä»¶</button>
    </form>
  </div>
</details>
{% else %}
<div class="library-limit-reached">
  <div class="library-limit-reached__icon">ğŸŒ™</div>
  <div class="library-limit-reached__title">ä»Šæ—¥ä¸Šä¼ å·²è¾¾ä¸Šé™</div>
  <div class="library-limit-reached__text">
    ä¸ºä¿æŠ¤æœåŠ¡å™¨èµ„æºï¼Œæ¯å¤©æœ€å¤šä¸Šä¼  {{ max_daily_uploads }} ä¸ªæ–‡ä»¶<br>
    æ˜å¤©é›¶ç‚¹åå°†é‡æ–°å¼€æ”¾ï¼Œè¯·ç¨åå†æ¥~
  </div>
  <div class="library-limit-reached__progress">
    <div class="library-limit-reached__bar" style="width: 100%"></div>
  </div>
  <div class="library-limit-reached__count">{{ today_uploads }} / {{ max_daily_uploads }}</div>
</div>
{% endif %}

<!-- File Showcase -->
<section class="library-showcase">
  <div class="library-showcase__header">
    <h2 class="library-showcase__title">ğŸ“– èµ„æ–™å±•ç¤ºæŸœ</h2>
    <span class="library-showcase__count">
      {% if q %}
      æ‰¾åˆ° {{ files|length }} / {{ all_files_count }} ä»½
      {% else %}
      å…± {{ all_files_count }} ä»½èµ„æ–™
      {% endif %}
    </span>
  </div>

  {% if files %}
  <div class="library-grid">
    {% for f in files %}
    <div class="library-item-wrap">
      <a class="library-item" href="/library/files/{{ f.name|urlencode }}" title="ä¸‹è½½ {{ f.name }}">
        <div class="library-item__icon library-item__icon--{{ f.ext }}">
          {% if f.ext == 'pdf' %}
          <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="8" y="4" width="32" height="40" rx="4" fill="#E53935" />
            <path d="M16 20h16M16 26h16M16 32h10" stroke="#fff" stroke-width="2" stroke-linecap="round" />
            <text x="24" y="16" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">PDF</text>
          </svg>
          {% elif f.ext in ['doc', 'docx'] %}
          <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="8" y="4" width="32" height="40" rx="4" fill="#1976D2" />
            <path d="M16 20h16M16 26h16M16 32h10" stroke="#fff" stroke-width="2" stroke-linecap="round" />
            <text x="24" y="16" text-anchor="middle" fill="#fff" font-size="7" font-weight="bold">WORD</text>
          </svg>
          {% elif f.ext == 'pptx' %}
          <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="8" y="4" width="32" height="40" rx="4" fill="#D84315" />
            <rect x="14" y="18" width="20" height="14" rx="2" fill="#fff" fill-opacity="0.9" />
            <text x="24" y="16" text-anchor="middle" fill="#fff" font-size="7" font-weight="bold">PPT</text>
          </svg>
          {% else %}
          <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="8" y="4" width="32" height="40" rx="4" fill="#546E7A" />
            <path d="M16 20h16M16 26h16M16 32h10" stroke="#fff" stroke-width="2" stroke-linecap="round" />
          </svg>
          {% endif %}
        </div>
        <div class="library-item__info">
          <div class="library-item__name">{{ f.display_name }}</div>
          <div class="library-item__meta">
            <span class="library-item__size">{{ f.size_text }}</span>
            <span class="library-item__date">{{ f.updated_at }}</span>
          </div>
        </div>
        <div class="library-item__download">
          <span class="library-item__download-icon">â¬‡ï¸</span>
        </div>
      </a>
      <form class="library-item__delete-form" method="post" action="/library/delete/{{ f.name|urlencode }}"
        data-confirm="ç¡®å®šè¦åˆ é™¤ã€Œ{{ f.display_name }}ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚">
        <button class="library-item__delete-btn" type="submit" title="åˆ é™¤æ–‡ä»¶">
          ğŸ—‘ï¸
        </button>
      </form>
    </div>
    {% endfor %}
  </div>
  {% else %}
  {% if all_files_count > 0 and q %}
  <section class="empty-state">
    <div class="empty-state__icon">ğŸ”</div>
    <h3 class="empty-state__title">æ²¡æœ‰åŒ¹é…ç»“æœ</h3>
    <p class="empty-state__text">è¯•è¯•æ¢ä¸ªå…³é”®è¯ï¼Œæˆ–æ¸…ç©ºæœç´¢æ¡ä»¶</p>
  </section>
  {% else %}
  <section class="empty-state">
    <div class="empty-state__icon">ğŸ“š</div>
    <h3 class="empty-state__title">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</h3>
    <p class="empty-state__text">ä¸Šä¼ ç¬¬ä¸€ä»½æ–‡æ¡£ï¼Œå¼€å¯çŸ¥è¯†å…±äº«ä¹‹æ—…ï¼</p>
  </section>
  {% endif %}
  {% endif %}
</section>

<script>
  // Drag and drop enhancement
  document.addEventListener('DOMContentLoaded', () => {
    const dropzone = document.getElementById('dropzone')
    if (dropzone) {
      ['dragenter', 'dragover'].forEach(event => {
        dropzone.addEventListener(event, (e) => {
          e.preventDefault()
          dropzone.classList.add('library-upload__dropzone--dragover')
        })
      });

      ['dragleave', 'drop'].forEach(event => {
        dropzone.addEventListener(event, (e) => {
          e.preventDefault()
          dropzone.classList.remove('library-upload__dropzone--dragover')
        })
      })

      const fileInput = dropzone.querySelector('input[type="file"]')
      dropzone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files
        if (files.length > 0) {
          fileInput.files = files
          const textEl = dropzone.querySelector('.library-upload__text')
          if (textEl) {
            textEl.textContent = files[0].name
          }
        }
      })

      fileInput.addEventListener('change', () => {
        const textEl = dropzone.querySelector('.library-upload__text')
        if (textEl && fileInput.files.length > 0) {
          textEl.textContent = fileInput.files[0].name
        }
      })
    }
  });
</script>
{% endblock %}