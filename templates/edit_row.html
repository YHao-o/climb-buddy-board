{% extends "base.html" %}

{% block content %}
{% set is_preview_sheet = (sheet_name in ['å…¶ä»–è®¾å¤‡', 'æ”€å²©é‹']) %}
{% set is_beginner_sheet = (sheet_name == 'æ–°æ‰‹æ³¨æ„äº‹é¡¹') %}
{% set show_images = (is_preview_sheet or is_beginner_sheet) %}

<section class="sheetbar">
  <div class="sheetbar__label">è¿”å›</div>
  <nav class="tabs" aria-label="è¿”å›å¯¼èˆª">
    <a class="tab tab--active" href="/guide?sheet={{ sheet_name|urlencode }}&edit=1">â† è¿”å› {{ sheet_name }}</a>
  </nav>
</section>

{% if err %}
<div class="alert alert--error">
  <span class="alert__icon">âš ï¸</span>
  <span class="alert__text">{{ err }}</span>
</div>
{% endif %}

{% if msg %}
<div class="alert alert--success">
  <span class="alert__icon">âœ…</span>
  <span class="alert__text">{{ msg }}</span>
</div>
{% endif %}

<section class="form-card">
  <h2 class="form-card__title" style="margin-bottom: 24px;">ç¼–è¾‘è¡Œ #{{ row_id }}</h2>

  <form class="editform" method="post" action="/row/{{ row_id }}/edit?sheet={{ sheet_name|urlencode }}">
    {% for c in sheet.columns %}
    <label class="field">
      <span class="field__label">{{ c }}</span>
      {% set v = (data.get(c) or '') %}
      {% set is_answer_col = (('å›ç­”' in c) or ('å›å¤' in c) or ('ç­”å¤' in c) or (c.lower() == 'answer')) %}
      {% if is_beginner_sheet and is_answer_col %}
      <textarea class="input edit-textarea" name="{{ c }}" rows="6">{{ v }}</textarea>
      {% else %}
      <input class="input" name="{{ c }}" value="{{ v }}" />
      {% endif %}
    </label>
    {% endfor %}

    <div class="editform__actions">
      <button class="btn btn--primary" type="submit">ğŸ’¾ ä¿å­˜</button>
      <a class="btn btn--secondary" href="/guide?sheet={{ sheet_name|urlencode }}&edit=1">å–æ¶ˆ</a>
    </div>
  </form>
</section>

{# ===== å›¾ç‰‡ç®¡ç†åŒºï¼ˆå…¶ä»–è®¾å¤‡/æ”€å²©é‹ å’Œ æ–°æ‰‹æ³¨æ„äº‹é¡¹ å…±ç”¨åŒä¸€ç»„ä»¶ï¼‰ ===== #}
{% if show_images %}
<section class="form-card" style="margin-top: 16px;">
  <div class="callout__title">
    {% if is_preview_sheet %}ğŸ“· é¢„è§ˆå›¾ç®¡ç†{% else %}ğŸ“· å›ç­”å›¾ç‰‡{% endif %}
  </div>
  {% if is_beginner_sheet %}
  <p class="muted" style="margin: 4px 0 12px;">ä¸Šä¼ çš„å›¾ç‰‡ä¼šå±•ç¤ºåœ¨åˆ—è¡¨é¡µçš„å›ç­”åŒºåŸŸ</p>
  {% endif %}

  {% if row_images and row_images|length > 0 %}
  <div class="row-images-gallery">
    {% for img in row_images %}
    <div class="row-image-item">
      <a href="/images/{{ img.filename|urlencode }}" class="row-image-item__link"
        data-image-src="/images/{{ img.filename|urlencode }}" data-image-alt="{{ img.original_name or img.filename }}">
        <img class="row-image-item__img" src="/images/{{ img.filename|urlencode }}"
          alt="{{ img.original_name or img.filename }}" loading="lazy" />
      </a>
      <div class="row-image-item__info">
        <span class="row-image-item__name" title="{{ img.original_name or img.filename }}">{{ img.original_name or
          img.filename }}</span>
        <form method="post" action="/row/{{ row_id }}/delete-image/{{ img.id }}?sheet={{ sheet_name|urlencode }}"
          class="inline" data-confirm="ç¡®è®¤åˆ é™¤è¿™å¼ å›¾ç‰‡ï¼Ÿ">
          <button class="btn btn--ghost btn--small row-image-item__delete" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="muted" style="margin: 12px 0 16px;">
    {% if is_preview_sheet %}æš‚æ— å›¾ç‰‡ï¼Œä¸Šä¼ åä¼šåœ¨å¡ç‰‡ä¸­å±•ç¤º{% else %}æš‚æ— å›¾ç‰‡ï¼Œä¸Šä¼ åä¼šåœ¨å›ç­”åŒºåŸŸå±•ç¤º{% endif %}
  </p>
  {% endif %}

  <form class="row-image-upload" action="/row/{{ row_id }}/upload-image?sheet={{ sheet_name|urlencode }}" method="post"
    enctype="multipart/form-data">
    <label class="row-image-upload__dropzone" data-dropzone>
      <input class="row-image-upload__input" type="file" name="file" accept="image/*" required />
      <div class="row-image-upload__text">ğŸ“ ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡</div>
      <div class="row-image-upload__hint">png / jpg / gif / webp Â· æœ€å¤§ 10MB</div>
    </label>
    <button class="btn btn--primary" type="submit">â¬†ï¸ ä¸Šä¼ å›¾ç‰‡</button>
  </form>
</section>
{% endif %}

{% if is_preview_sheet and sheet and sheet.image_column %}
<section class="callout" style="margin-top: 16px;">
  <div class="callout__title">ğŸ’¡ å›¾ç‰‡åˆ—æç¤º</div>
  <div class="callout__body">
    <p>æ­¤è¡¨æœ‰å›¾ç‰‡åˆ—ã€Œ<strong>{{ sheet.image_column }}</strong>ã€ï¼Œé™¤äº†ä¸Šæ–¹çš„å›¾ç‰‡ç®¡ç†ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†æ–‡ä»¶åå¡«åˆ°è¯¥å­—æ®µæ¥å±•ç¤ºå›¾ç‰‡ã€‚</p>
  </div>
</section>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-dropzone]').forEach((dropzone) => {
      const fileInput = dropzone.querySelector('input[type="file"]')
      if (!fileInput) return
      const setText = (name) => {
        const textEl = dropzone.querySelector('.row-image-upload__text')
        if (textEl) textEl.textContent = name || 'ğŸ“ ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡'
      }
        ;['dragenter', 'dragover'].forEach(evt => {
          dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('row-image-upload__dropzone--dragover') })
        })
        ;['dragleave', 'drop'].forEach(evt => {
          dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('row-image-upload__dropzone--dragover') })
        })
      dropzone.addEventListener('drop', e => {
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files
          setText(e.dataTransfer.files[0].name)
        }
      })
      fileInput.addEventListener('change', () => {
        setText(fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '')
      })
    })
  })
</script>
{% endblock %}