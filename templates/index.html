{% extends "base.html" %}

{% block content %}
{% if not excel_exists %}
<section class="callout callout--warn">
  <div class="callout__title">âš ï¸ æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶</div>
  <div class="callout__body">
    è¯·ç¡®è®¤ Excel æ–‡ä»¶æ”¾åœ¨ä¸ <code>main.py</code> åŒçº§ç›®å½•ï¼Œæ–‡ä»¶åä¸º <code>æ·±åœ³å¸‚çˆ¬å¢™åŒºæ–°æ‰‹æ‘æŒ‡å—.xlsx</code>
  </div>
</section>
{% endif %}

{% if workbook.sheets|length == 0 %}
<section class="empty-state">
  <div class="empty-state__icon">ğŸ“„</div>
  <h3 class="empty-state__title">æš‚æ— æ•°æ®</h3>
  <p class="empty-state__text">å¦‚æœåˆšæ”¾å…¥ Excelï¼Œåˆ·æ–°é¡µé¢å³å¯ã€‚</p>
</section>
{% else %}

<section class="sheetbar">
  <div class="sheetbar__label">å·¥ä½œè¡¨</div>
  <nav class="tabs" aria-label="å·¥ä½œè¡¨åˆ‡æ¢">
    {% for s in workbook.sheets %}
    {% set active = (s.name == active_sheet) %}
    <a class="tab {{ 'tab--active' if active else '' }}"
      href="{{ base_path }}?sheet={{ s.name|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view={{ view }}{% if edit %}&edit=1{% endif %}">
      {{ s.name }}
    </a>
    {% endfor %}
  </nav>
</section>

{% set controls_open = (q or column or value or edit) %}
<details class="collapse" {% if controls_open %}open{% endif %}>
  <summary>
    <span>ğŸ” æœç´¢ / ç­›é€‰ / åˆ‡æ¢è§†å›¾</span>
    <span class="collapse__hint">å±•å¼€</span>
  </summary>
  <div class="collapse__body">
    <section class="toolbar" style="margin-top:0;">
      <form class="search" method="get" action="{{ base_path }}">
        <input type="hidden" name="sheet" value="{{ active_sheet }}" />
        <input type="hidden" name="view" value="{{ view }}" />
        {% if edit %}
        <input type="hidden" name="edit" value="1" />
        {% endif %}

        <div class="search__row">
          <label class="field">
            <span class="field__label">å…³é”®è¯</span>
            <input class="input" name="q" value="{{ q }}" placeholder="è£…å¤‡ / æŠ¥å / ä¿æŠ¤ / åœºé¦†â€¦" />
          </label>

          <label class="field">
            <span class="field__label">æŒ‰åˆ—ç­›é€‰</span>
            <select class="select" name="column">
              <option value="" {% if not column %}selected{% endif %}>ï¼ˆä¸ç­›é€‰ï¼‰</option>
              {% if sheet %}
              {% for c in sheet.columns %}
              <option value="{{ c }}" {% if column==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
              {% endif %}
            </select>
          </label>

          <label class="field">
            <span class="field__label">åŒ…å«å€¼</span>
            <input class="input" name="value" value="{{ value }}" placeholder="ç­›é€‰å€¼" />
          </label>

          <button class="btn btn--primary" type="submit">æœç´¢</button>
          <a class="btn btn--secondary"
            href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&view={{ view }}{% if edit %}&edit=1{% endif %}">æ¸…ç©º</a>
        </div>
      </form>

      <div class="viewtoggle" aria-label="è§†å›¾åˆ‡æ¢">
        <a class="btn {{ 'btn--active' if view == 'cards' else 'btn--ghost' }}"
          href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view=cards{% if edit %}&edit=1{% endif %}">
          ğŸƒ å¡ç‰‡
        </a>
        <a class="btn {{ 'btn--active' if view == 'table' else 'btn--ghost' }}"
          href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view=table{% if edit %}&edit=1{% endif %}">
          ğŸ“Š è¡¨æ ¼
        </a>
      </div>
    </section>
  </div>
</details>

<section class="summary">
  <div class="summary__stats">
    <div class="stat">
      <span class="stat__value">{{ rows|length }}</span>
      <span class="stat__label">æ¡ç»“æœ</span>
    </div>
  </div>
  <div class="summary__actions">
    {% if enable_edit %}
    {% if edit %}
    <a class="btn btn--secondary btn--small"
      href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view={{ view }}">
      é€€å‡ºç¼–è¾‘
    </a>
    {% else %}
    <a class="btn btn--secondary btn--small"
      href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view={{ view }}&edit=1">
      âœï¸ è¿›å…¥ç¼–è¾‘
    </a>
    {% endif %}
    {% endif %}
  </div>
</section>

{% if err %}
<section class="callout callout--warn">
  <div class="callout__title">âš ï¸ ä¿å­˜å¤±è´¥</div>
  <div class="callout__body">{{ err }}</div>
</section>
{% endif %}

{% if edit %}
<section class="callout">
  <div class="callout__title">âœï¸ ç¼–è¾‘æ¨¡å¼</div>
  <div class="callout__body">
    <form class="inline" method="post" action="/row/new?sheet={{ active_sheet|urlencode }}">
      <button class="btn btn--primary" type="submit">â• æ–°å¢ä¸€è¡Œ</button>
    </form>
    <p class="muted mt-2">æç¤ºï¼šæ”¹åŠ¨ä¼šç«‹å³ä¿å­˜åˆ°æ•°æ®åº“</p>
  </div>
</section>

<section class="callout">
  <div class="callout__title">ğŸ“ å†…å®¹ç»´æŠ¤</div>
  <div class="callout__body">
    <form class="editform" method="post" action="/guide/settings/update">
      <input type="hidden" name="sheet" value="{{ active_sheet }}" />
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="column" value="{{ column }}" />
      <input type="hidden" name="value" value="{{ value }}" />
      <input type="hidden" name="view" value="{{ view }}" />
      <input type="hidden" name="shoes_tips_version" value="{{ shoes_tips_version }}" />
      <input type="hidden" name="ticket_tips_version" value="{{ ticket_tips_version }}" />

      <label class="field">
        <span class="field__label">ğŸ‘Ÿ æ”€å²©é‹é€‰è´­å»ºè®®ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</span>
        <textarea class="input" name="shoes_tips" rows="5">{{ shoes_tips_text }}</textarea>
      </label>
      <label class="field">
        <span class="field__label">ğŸ« é—¨ç¥¨ä¾¿å®œè´­ä¹°é€”å¾„ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</span>
        <textarea class="input" name="ticket_tips" rows="5">{{ ticket_tips_text }}</textarea>
      </label>

      <div class="editform__actions">
        <button class="btn btn--primary" type="submit">ğŸ’¾ ä¿å­˜</button>
      </div>
    </form>
    <p class="muted mt-2">å¤šäººåŒæ—¶ç¼–è¾‘æ—¶ï¼Œä¿å­˜ä¼šæç¤ºå†²çªï¼Œè¯·åˆ·æ–°åé‡è¯•ã€‚</p>
  </div>
</section>
{% endif %}

{% if sheet and sheet.image_column %}
<section class="callout">
  <div class="callout__title">ğŸ“· ä¸Šä¼ å›¾ç‰‡</div>
  <div class="callout__body">
    <p class="muted">ä¸Šä¼ åå°†æ–‡ä»¶åå¡«å…¥ã€Œ{{ sheet.image_column }}ã€åˆ—å³å¯å±•ç¤º</p>
    <form class="upload" action="/upload?sheet={{ active_sheet|urlencode }}" method="post"
      enctype="multipart/form-data">
      <input class="input" type="file" name="file" accept="image/*" required style="flex:1;" />
      <button class="btn btn--primary" type="submit">ä¸Šä¼ </button>
    </form>
    {% if uploaded %}
    <div class="upload__result">
      âœ… å·²ä¸Šä¼ ï¼š<code>{{ uploaded }}</code>
    </div>
    {% endif %}
  </div>
</section>
{% endif %}

{% if "æ”€å²©é‹" in active_sheet %}
<section class="callout">
  <div class="callout__title">ğŸ‘Ÿ æ”€å²©é‹é€‰è´­å»ºè®®</div>
  <div class="callout__body">
    <ul class="list">
      {% if shoes_tips_lines|length == 0 %}
      <li class="muted">æš‚æ— å†…å®¹</li>
      {% else %}
      {% for tip in shoes_tips_lines %}
      <li>{{ tip }}</li>
      {% endfor %}
      {% endif %}
    </ul>
  </div>
</section>
{% endif %}

{% if "å²©é¦†" in active_sheet %}
<section class="callout">
  <div class="callout__title">ğŸ« é—¨ç¥¨ä¾¿å®œè´­ä¹°é€”å¾„</div>
  <div class="callout__body">
    <ul class="list">
      {% if ticket_tips_lines|length == 0 %}
      <li class="muted">æš‚æ— å†…å®¹</li>
      {% else %}
      {% for tip in ticket_tips_lines %}
      <li>{{ tip }}</li>
      {% endfor %}
      {% endif %}
    </ul>
  </div>
</section>
{% endif %}

{% if rows|length == 0 %}
<section class="empty-state">
  <div class="empty-state__icon">ğŸ”</div>
  <h3 class="empty-state__title">æ²¡æœ‰åŒ¹é…ç»“æœ</h3>
  <p class="empty-state__text">æ¢ä¸ªå…³é”®è¯è¯•è¯•ï¼Œæˆ–æ¸…ç©ºç­›é€‰æ¡ä»¶</p>
</section>
{% else %}

{% if view == "table" %}
<section class="tablewrap">
  <table class="table">
    <thead>
      <tr>
        {% if sheet and sheet.image_column %}
        <th class="table__th table__th--img">å›¾ç‰‡</th>
        {% endif %}
        {% if edit %}
        <th class="table__th table__th--img">æ“ä½œ</th>
        {% endif %}
        {% if sheet %}
        {% for c in sheet.columns %}
        <th class="table__th">{{ c }}</th>
        {% endfor %}
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        {% if sheet and sheet.image_column %}
        <td class="table__td table__td--img">
          {% if images_mounted and r.get('__image__') %}
          <a class="link" href="/images/{{ r.get('__image__')|urlencode }}" target="_blank">æŸ¥çœ‹</a>
          {% else %}
          <span class="muted">â€”</span>
          {% endif %}
        </td>
        {% endif %}
        {% if edit %}
        {% set ns = namespace(items=[]) %}
        {% if sheet %}
        {% for c in sheet.columns %}
        {% if ns.items|length < 2 %} {% set v=r.get(c) %} {% if v is not none and v !='' %} {% set ns.items=ns.items +
          [c ~ 'ï¼š' ~ v] %} {% endif %} {% endif %} {% endfor %} {% endif %} <td class="table__td table__td--img">
          <a class="link" href="/row/{{ r.get('__id__') }}/edit?sheet={{ active_sheet|urlencode }}">ç¼–è¾‘</a>
          <form method="post" action="/row/{{ r.get('__id__') }}/delete?sheet={{ active_sheet|urlencode }}"
            class="inline" data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ&#10;{{ (ns.items|join('ï¼›') if ns.items|length > 0 else 'ï¼ˆæ— å†…å®¹ï¼‰') }}">
            <button class="linkbtn" type="submit">åˆ é™¤</button>
          </form>
          </td>
          {% endif %}
          {% if sheet %}
          {% for c in sheet.columns %}
          <td class="table__td">{{ r.get(c)|linkify }}</td>
          {% endfor %}
          {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% else %}
<section class="cards">
  {% for r in rows %}
  <article class="card">
    {% if sheet and sheet.image_column and images_mounted and r.get('__image__') %}
    <a class="card__media" href="/images/{{ r.get('__image__')|urlencode }}" target="_blank">
      <img class="card__img" src="/images/{{ r.get('__image__')|urlencode }}" alt="{{ r.get('__image__') }}"
        loading="lazy" />
    </a>
    {% endif %}

    <div class="card__body">
      {% if edit %}
      {% set ns = namespace(items=[]) %}
      {% if sheet %}
      {% for c in sheet.columns %}
      {% if ns.items|length < 2 %} {% set v=r.get(c) %} {% if v is not none and v !='' %} {% set ns.items=ns.items + [c
        ~ 'ï¼š' ~ v] %} {% endif %} {% endif %} {% endfor %} {% endif %} <div class="card__actions">
        <a class="btn btn--secondary btn--small"
          href="/row/{{ r.get('__id__') }}/edit?sheet={{ active_sheet|urlencode }}">âœï¸ ç¼–è¾‘</a>
        <form method="post" action="/row/{{ r.get('__id__') }}/delete?sheet={{ active_sheet|urlencode }}"
          data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ&#10;{{ (ns.items|join('ï¼›') if ns.items|length > 0 else 'ï¼ˆæ— å†…å®¹ï¼‰') }}">
          <button class="btn btn--secondary btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
    </div>
    {% endif %}
    <dl class="kv">
      {% if sheet %}
      {% for c in sheet.columns %}
      {% set v = r.get(c) %}
      {% if v is not none and v != '' %}
      <div class="kv__row">
        <dt class="kv__k">{{ c }}</dt>
        <dd class="kv__v">{{ v|linkify }}</dd>
      </div>
      {% endif %}
      {% endfor %}
      {% endif %}
    </dl>
    </div>
  </article>
  {% endfor %}
</section>
{% endif %}

{% endif %}
{% endif %}
{% endblock %}