{% extends "base.html" %}

{% block content %}
{% if (not excel_exists) and (workbook.sheets|length == 0) %}
<section class="callout callout--warn">
  <div class="callout__title">âš ï¸ æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶</div>
  <div class="callout__body">
    è¯·ç¡®è®¤ Excel æ–‡ä»¶æ”¾åœ¨ä¸ <code>main.py</code> åŒçº§ç›®å½•ï¼Œæ–‡ä»¶åä¸º <code>æ·±åœ³å¸‚çˆ¬å¢™åŒºæ–°æ‰‹æ‘æŒ‡å—.xlsx</code>
  </div>
</section>
{% endif %}

{% if workbook.sheets|length == 0 %}
<section class="empty-state">
  <div class="empty-state__icon">ğŸ“„</div>
  <h3 class="empty-state__title">æš‚æ— æ•°æ®</h3>
  <p class="empty-state__text">å¦‚æœåˆšæ”¾å…¥ Excelï¼Œåˆ·æ–°é¡µé¢å³å¯ã€‚</p>
</section>
{% else %}

{% set is_preview_sheet = (active_sheet in ['å…¶ä»–è®¾å¤‡', 'æ”€å²©é‹']) %}
{% set is_beginner_sheet = (active_sheet == 'æ–°æ‰‹æ³¨æ„äº‹é¡¹') %}

<section class="sheetbar">
  <div class="sheetbar__label">å·¥ä½œè¡¨</div>
  <nav class="tabs" aria-label="å·¥ä½œè¡¨åˆ‡æ¢">
    {% for s in workbook.sheets %}
    {% set active = (s.name == active_sheet) %}
    <a class="tab {{ 'tab--active' if active else '' }}"
      href="{{ base_path }}?sheet={{ s.name|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view={{ view }}{% if edit %}&edit=1{% endif %}">
      {{ s.name }}
    </a>
    {% endfor %}
  </nav>
</section>

{% set controls_open = (q or column or value or edit) %}
<details class="collapse" {% if controls_open %}open{% endif %}>
  <summary>
    <span>ğŸ” æœç´¢ / ç­›é€‰ / åˆ‡æ¢è§†å›¾</span>
    <span class="collapse__hint">å±•å¼€</span>
  </summary>
  <div class="collapse__body">
    <section class="toolbar" style="margin-top:0;">
      <form class="search" method="get" action="{{ base_path }}">
        <input type="hidden" name="sheet" value="{{ active_sheet }}" />
        <input type="hidden" name="view" value="{{ view }}" />
        {% if edit %}
        <input type="hidden" name="edit" value="1" />
        {% endif %}

        <div class="search__row">
          <label class="field">
            <span class="field__label">å…³é”®è¯</span>
            <input class="input" name="q" value="{{ q }}" placeholder="è£…å¤‡ / æŠ¥å / ä¿æŠ¤ / åœºé¦†â€¦" />
          </label>

          <label class="field">
            <span class="field__label">æŒ‰åˆ—ç­›é€‰</span>
            <select class="select" name="column">
              <option value="" {% if not column %}selected{% endif %}>ï¼ˆä¸ç­›é€‰ï¼‰</option>
              {% if sheet %}
              {% for c in sheet.columns %}
              <option value="{{ c }}" {% if column==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
              {% endif %}
            </select>
          </label>

          <label class="field">
            <span class="field__label">åŒ…å«å€¼</span>
            <input class="input" name="value" value="{{ value }}" placeholder="ç­›é€‰å€¼" />
          </label>

          <button class="btn btn--primary" type="submit">æœç´¢</button>
          <a class="btn btn--secondary"
            href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&view={{ view }}{% if edit %}&edit=1{% endif %}">æ¸…ç©º</a>
        </div>
      </form>

      <div class="viewtoggle" aria-label="è§†å›¾åˆ‡æ¢">
        <a class="btn {{ 'btn--active' if view == 'cards' else 'btn--ghost' }}"
          href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view=cards{% if edit %}&edit=1{% endif %}">
          ğŸƒ å¡ç‰‡
        </a>
        <a class="btn {{ 'btn--active' if view == 'table' else 'btn--ghost' }}"
          href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view=table{% if edit %}&edit=1{% endif %}">
          ğŸ“Š è¡¨æ ¼
        </a>
      </div>
    </section>
  </div>
</details>

<section class="summary">
  <div class="summary__stats">
    <div class="stat">
      <span class="stat__value">{{ rows|length }}</span>
      <span class="stat__label">æ¡ç»“æœ</span>
    </div>
  </div>
  <div class="summary__actions">
    {% if enable_edit %}
    {% if edit %}
    <a class="btn btn--secondary btn--small"
      href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view={{ view }}">
      é€€å‡ºç¼–è¾‘
    </a>
    {% else %}
    <a class="btn btn--secondary btn--small"
      href="{{ base_path }}?sheet={{ active_sheet|urlencode }}&q={{ q|urlencode }}&column={{ column|urlencode }}&value={{ value|urlencode }}&view={{ view }}&edit=1">
      âœï¸ è¿›å…¥ç¼–è¾‘
    </a>
    {% endif %}
    {% endif %}
  </div>
</section>

{% if err %}
<section class="callout callout--warn">
  <div class="callout__title">âš ï¸ ä¿å­˜å¤±è´¥</div>
  <div class="callout__body">{{ err }}</div>
</section>
{% endif %}

{% if edit %}
<section class="callout">
  <div class="callout__title">âœï¸ ç¼–è¾‘æ¨¡å¼</div>
  <div class="callout__body">
    <form class="inline" method="post" action="/row/new?sheet={{ active_sheet|urlencode }}">
      <button class="btn btn--primary" type="submit">â• æ–°å¢ä¸€è¡Œ</button>
    </form>
    <p class="muted mt-2">æç¤ºï¼šæ”¹åŠ¨ä¼šç«‹å³ä¿å­˜åˆ°æ•°æ®åº“</p>
  </div>
</section>

<section class="callout">
  <div class="callout__title">ğŸ“ å†…å®¹ç»´æŠ¤</div>
  <div class="callout__body">
    <form class="editform" method="post" action="/guide/settings/update">
      <input type="hidden" name="sheet" value="{{ active_sheet }}" />
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="column" value="{{ column }}" />
      <input type="hidden" name="value" value="{{ value }}" />
      <input type="hidden" name="view" value="{{ view }}" />
      <input type="hidden" name="shoes_tips_version" value="{{ shoes_tips_version }}" />
      <input type="hidden" name="ticket_tips_version" value="{{ ticket_tips_version }}" />

      <label class="field">
        <span class="field__label">ğŸ‘Ÿ æ”€å²©é‹é€‰è´­å»ºè®®ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</span>
        <textarea class="input" name="shoes_tips" rows="5">{{ shoes_tips_text }}</textarea>
      </label>
      <label class="field">
        <span class="field__label">ğŸ« é—¨ç¥¨ä¾¿å®œè´­ä¹°é€”å¾„ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</span>
        <textarea class="input" name="ticket_tips" rows="5">{{ ticket_tips_text }}</textarea>
      </label>

      <div class="editform__actions">
        <button class="btn btn--primary" type="submit">ğŸ’¾ ä¿å­˜</button>
      </div>
    </form>
    <p class="muted mt-2">å¤šäººåŒæ—¶ç¼–è¾‘æ—¶ï¼Œä¿å­˜ä¼šæç¤ºå†²çªï¼Œè¯·åˆ·æ–°åé‡è¯•ã€‚</p>
  </div>
</section>
{% endif %}

{# é¢„è§ˆå›¾ä»…ç”¨äºâ€œå…¶ä»–è®¾å¤‡/æ”€å²©é‹â€ï¼Œå…¶ä»–è¡¨ä¸å±•ç¤ºè¿™ä¸ªä¸Šä¼ æç¤ºï¼ˆé¿å…è¯¯å¯¼ï¼‰ #}
{% if is_preview_sheet %}
<section class="callout">
  <div class="callout__title">ğŸ“· é¢„è§ˆå›¾ï¼ˆå…¶ä»–è®¾å¤‡/æ”€å²©é‹ï¼‰</div>
  <div class="callout__body">
    <p class="muted">åœ¨ç¼–è¾‘å•æ¡è®°å½•é‡Œä¸Šä¼ å›¾ç‰‡ï¼Œä¼šè‡ªåŠ¨ç»‘å®šä¸ºè¯¥æ¡ç›®çš„é¢„è§ˆå›¾ã€‚</p>
  </div>
</section>
{% endif %}

{% if "æ”€å²©é‹" in active_sheet %}
<section class="callout">
  <div class="callout__title">ğŸ‘Ÿ æ”€å²©é‹é€‰è´­å»ºè®®</div>
  <div class="callout__body">
    <ul class="list">
      {% if shoes_tips_lines|length == 0 %}
      <li class="muted">æš‚æ— å†…å®¹</li>
      {% else %}
      {% for tip in shoes_tips_lines %}
      <li>{{ tip }}</li>
      {% endfor %}
      {% endif %}
    </ul>
  </div>
</section>
{% endif %}

{% if "å²©é¦†" in active_sheet %}
<section class="callout">
  <div class="callout__title">ğŸ« é—¨ç¥¨ä¾¿å®œè´­ä¹°é€”å¾„</div>
  <div class="callout__body">
    <ul class="list">
      {% if ticket_tips_lines|length == 0 %}
      <li class="muted">æš‚æ— å†…å®¹</li>
      {% else %}
      {% for tip in ticket_tips_lines %}
      <li>{{ tip }}</li>
      {% endfor %}
      {% endif %}
    </ul>
  </div>
</section>
{% endif %}

{% if rows|length == 0 %}
<section class="empty-state">
  <div class="empty-state__icon">ğŸ”</div>
  <h3 class="empty-state__title">æ²¡æœ‰åŒ¹é…ç»“æœ</h3>
  <p class="empty-state__text">æ¢ä¸ªå…³é”®è¯è¯•è¯•ï¼Œæˆ–æ¸…ç©ºç­›é€‰æ¡ä»¶</p>
</section>
{% else %}

{% if view == "table" %}
<section class="tablewrap">
  <table class="table">
    <thead>
      <tr>
        {% if is_preview_sheet %}
        <th class="table__th table__th--img">å›¾ç‰‡</th>
        {% endif %}
        {% if edit %}
        <th class="table__th table__th--img">æ“ä½œ</th>
        {% endif %}
        {% if sheet %}
        {% for c in sheet.columns %}
        <th class="table__th">{{ c }}</th>
        {% endfor %}
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        {% if is_preview_sheet %}
        <td class="table__td table__td--img">
          {% set imgs = r.get('__row_images__') or [] %}
          {% if imgs|length > 0 %}
          {% set img = imgs[-1].filename %}
          <a class="thumb" href="/images/{{ img|urlencode }}" data-image-src="/images/{{ img|urlencode }}"
            data-image-alt="{{ img }}">
            <img src="/images/{{ img|urlencode }}" alt="{{ img }}" loading="lazy" />
          </a>
          {% if imgs|length > 1 %}
          <span class="badge badge--success" style="margin-left:6px;">+{{ imgs|length - 1 }}</span>
          {% endif %}
          {% else %}
          <span class="muted">â€”</span>
          {% endif %}
        </td>
        {% endif %}
        {% if edit %}
        {% set ns = namespace(items=[]) %}
        {% if sheet %}
        {% for c in sheet.columns %}
        {% if ns.items|length < 2 %} {% set v=r.get(c) %} {% if v is not none and v !='' %} {% set ns.items=ns.items +
          [c ~ 'ï¼š' ~ v] %} {% endif %} {% endif %} {% endfor %} {% endif %} <td class="table__td table__td--img">
          <a class="link" href="/row/{{ r.get('__id__') }}/edit?sheet={{ active_sheet|urlencode }}">ç¼–è¾‘</a>
          <form method="post" action="/row/{{ r.get('__id__') }}/delete?sheet={{ active_sheet|urlencode }}"
            class="inline" data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ&#10;{{ (ns.items|join('ï¼›') if ns.items|length > 0 else 'ï¼ˆæ— å†…å®¹ï¼‰') }}">
            <button class="linkbtn" type="submit">åˆ é™¤</button>
          </form>
          </td>
          {% endif %}
          {% if sheet %}
          {% for c in sheet.columns %}
          {% set v = r.get(c) %}
          {% set is_answer_col = (('å›ç­”' in c) or ('å›å¤' in c) or ('ç­”å¤' in c) or (c.lower() == 'answer')) %}
          <td class="table__td">
            {% if c == 'è´­ä¹°é“¾æ¥' and v is not none and v != '' %}
            <a class="link" href="#" data-copy-text="{{ v|e }}" title="ç‚¹å‡»å¤åˆ¶é“¾æ¥">{{ v }}</a>
            {% else %}
            {{ v|linkify }}
            {% endif %}
            {% if is_beginner_sheet and is_answer_col %}
            {% set imgs = r.get('__row_images__') or [] %}
            {% if imgs|length > 0 %}
            <div class="card__row-images" style="padding:8px 0 0;">
              {% for img in imgs %}
              <a class="card__row-img-link" href="/images/{{ img.filename|urlencode }}"
                data-image-src="/images/{{ img.filename|urlencode }}"
                data-image-alt="{{ img.original_name or img.filename }}">
                <img class="card__row-img" src="/images/{{ img.filename|urlencode }}"
                  alt="{{ img.original_name or img.filename }}" loading="lazy" />
              </a>
              {% endfor %}
            </div>
            {% endif %}
            {% endif %}
          </td>
          {% endfor %}
          {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% else %}
<section class="cards">
  {% for r in rows %}
  <article class="card">
    {% if is_preview_sheet %}
    {% set imgs = r.get('__row_images__') or [] %}
    {% if images_mounted and imgs|length > 0 %}
    {% set img = imgs[-1].filename %}
    <a class="card__media" href="/images/{{ img|urlencode }}" data-image-src="/images/{{ img|urlencode }}"
      data-image-alt="{{ img }}">
      <img class="card__img" src="/images/{{ img|urlencode }}" alt="{{ img }}" loading="lazy" />
      {% if imgs|length > 1 %}
      <span class="card__media-badge">+{{ imgs|length - 1 }}</span>
      {% endif %}
    </a>
    {% endif %}
    {% endif %}

    <div class="card__body">
      {% if edit %}
      {% set ns = namespace(items=[]) %}
      {% if sheet %}
      {% for c in sheet.columns %}
      {% if ns.items|length < 2 %} {% set v=r.get(c) %} {% if v is not none and v !='' %} {% set ns.items=ns.items + [c
        ~ 'ï¼š' ~ v] %} {% endif %} {% endif %} {% endfor %} {% endif %} <div class="card__actions">
        <a class="btn btn--secondary btn--small"
          href="/row/{{ r.get('__id__') }}/edit?sheet={{ active_sheet|urlencode }}">âœï¸ ç¼–è¾‘</a>
        <form method="post" action="/row/{{ r.get('__id__') }}/delete?sheet={{ active_sheet|urlencode }}"
          data-confirm="ç¡®è®¤åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ&#10;{{ (ns.items|join('ï¼›') if ns.items|length > 0 else 'ï¼ˆæ— å†…å®¹ï¼‰') }}">
          <button class="btn btn--secondary btn--small" type="submit">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
    </div>
    {% endif %}
    <dl class="kv">
      {% if sheet %}
      {% for c in sheet.columns %}
      {% set v = r.get(c) %}
      {% if v is not none and v != '' %}
      <div class="kv__row">
        <dt class="kv__k">{{ c }}</dt>
        {% set is_answer_col = (('å›ç­”' in c) or ('å›å¤' in c) or ('ç­”å¤' in c) or (c.lower() == 'answer')) %}
        <dd class="kv__v">
          {% if c == 'è´­ä¹°é“¾æ¥' and v is not none and v != '' %}
          <a class="link" href="#" data-copy-text="{{ v|e }}" title="ç‚¹å‡»å¤åˆ¶é“¾æ¥">{{ v }}</a>
          {% else %}
          {{ v|linkify }}
          {% endif %}
          {% if is_beginner_sheet and is_answer_col %}
          {% set imgs = r.get('__row_images__') or [] %}
          {% if imgs|length > 0 %}
          <div class="card__row-images" style="padding:8px 0 0;">
            {% for img in imgs %}
            <a class="card__row-img-link" href="/images/{{ img.filename|urlencode }}"
              data-image-src="/images/{{ img.filename|urlencode }}"
              data-image-alt="{{ img.original_name or img.filename }}">
              <img class="card__row-img" src="/images/{{ img.filename|urlencode }}"
                alt="{{ img.original_name or img.filename }}" loading="lazy" />
            </a>
            {% endfor %}
          </div>
          {% endif %}
          {% endif %}
        </dd>
      </div>
      {% endif %}
      {% endfor %}
      {% endif %}
    </dl>
    </div>
  </article>
  {% endfor %}
</section>
{% endif %}

{% endif %}
{% endif %}
{% endblock %}